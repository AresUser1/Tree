<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Christmas Tree</title>
    
    <style>
        #debug-console {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 40vh;
            background: rgba(0, 0, 0, 0.85);
            color: #00ff00;
            font-family: monospace;
            font-size: 10px;
            overflow-y: scroll;
            z-index: 99999;
            padding: 5px;
            pointer-events: none;
            border-bottom: 2px solid red;
            display: block;
        }
        .log-error { color: #ff3333; font-weight: bold; border-bottom: 1px solid #550000; }
        .log-warn { color: #ffff33; }
        .log-info { color: #00ff00; }
    </style>

    <script>
        window.logBuffer = [];
        
        function screenLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${message}`;
            
            const consoleDiv = document.getElementById('debug-console');
            if (consoleDiv) {
                const div = document.createElement('div');
                div.className = `log-${type}`;
                div.innerText = logLine;
                consoleDiv.appendChild(div);
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            } else {
                window.logBuffer.push({msg: logLine, type: type});
            }
            if(type === 'error') console.error(message);
            else console.log(message);
        }

        window.onerror = function(msg, url, line, col, error) {
            screenLog(`CRITICAL JS ERROR: ${msg}\nLine: ${line}:${col}`, 'error');
            return false;
        };

        window.onunhandledrejection = function(event) {
            screenLog(`UNHANDLED PROMISE: ${event.reason}`, 'error');
        };
    </script>

    <script src="https://telegram.org/js/telegram-web-app.js" onload="screenLog('Telegram Script Loaded')" onerror="screenLog('FAIL: Telegram Script NOT Loaded', 'error')"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" onload="screenLog('Supabase Script Loaded')" onerror="screenLog('FAIL: Supabase Script NOT Loaded', 'error')"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --panel-bg: rgba(15, 23, 42, 0.95);
            --accent-gold: #fbbf24;
            --accent-green: #22c55e;
        }

        body {
            margin: 0; padding: 0;
            background: #02040a;
            color: #f8fafc;
            font-family: 'Nunito', sans-serif;
            overflow-x: hidden;
            height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .background-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 30%, #1e293b 0%, #0f172a 40%, #020617 100%);
            z-index: 0;
        }
        
        .snow-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="1.5" fill="white" opacity="0.4"/><circle cx="50" cy="80" r="1" fill="white" opacity="0.4"/><circle cx="150" cy="30" r="2" fill="white" opacity="0.4"/><circle cx="100" cy="150" r="1.5" fill="white" opacity="0.4"/></svg>');
            animation: snow 20s linear infinite;
            pointer-events: none; z-index: 1;
        }
        @keyframes snow { from { background-position: 0 0; } to { background-position: 0 500px; } }

        .viewport {
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            z-index: 5;
        }

        .tree-stage {
            flex-grow: 1;
            position: relative;
            display: flex; 
            justify-content: center; 
            align-items: flex-end; 
            padding-bottom: 20px;
            overflow: visible;
            min-height: 250px;
        }

        .tree-svg {
            width: auto; height: auto;
            max-width: 90%; max-height: 95%;
            filter: drop-shadow(0 10px 40px rgba(0,0,0,0.6));
            z-index: 10; overflow: visible;
        }

        .star-shape { fill: #ffff00; stroke: #ca8a04; stroke-width: 1px; transition: all 1s; }
        .star-glowing { fill: #ffff00; stroke: none; } 

        .svg-bulb { transition: fill 0.5s ease, filter 0.5s ease; }
        .svg-bulb.c-red { fill: #7f1d1d; } .svg-bulb.c-yellow { fill: #854d0e; }
        .svg-bulb.c-blue { fill: #1e3a8a; } .svg-bulb.c-purple { fill: #581c87; }
        .svg-bulb.on.c-red { fill: #ef4444; filter: drop-shadow(0 0 10px #ef4444); }
        .svg-bulb.on.c-yellow { fill: #facc15; filter: drop-shadow(0 0 10px #facc15); }
        .svg-bulb.on.c-blue { fill: #60a5fa; filter: drop-shadow(0 0 10px #60a5fa); }
        .svg-bulb.on.c-purple { fill: #c084fc; filter: drop-shadow(0 0 10px #c084fc); }

        .base-layer {
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: flex-end; justify-content: center;
            z-index: 11; width: 100%; gap: 70px;
        }
        .gift { width: 40px; height: 40px; background: linear-gradient(135deg, #ef4444, #b91c1c); border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.6); position: relative; }
        .gift::before { content:''; position:absolute; left:50%; top:0; width:6px; height:100%; background:#fbbf24; transform:translateX(-50%); }
        .gift::after { content:''; position:absolute; top:50%; left:0; width:100%; height:6px; background:#fbbf24; transform:translateY(-50%); }
        .gift.blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); width: 50px; height: 35px; }
        .gift.blue::before, .gift.blue::after { background: #e2e8f0; }

        .control-panel {
            flex-shrink: 0;
            background: var(--panel-bg);
            border-top: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.9);
            border-radius: 24px 24px 0 0;
            padding: 20px 20px 40px 20px;
            display: flex; flex-direction: column;
            z-index: 20; 
            backdrop-filter: blur(15px);
        }

        .level-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
        .lvl-title { font-size: 13px; color: #94a3b8; text-transform: uppercase; font-weight: 800; }
        .lvl-val { font-size: 24px; color: var(--accent-gold); font-weight: 900; line-height: 1; }

        .progress-container {
            height: 20px; width: 100%; background: rgba(255,255,255,0.05);
            border-radius: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);
            position: relative; margin-bottom: 15px;
        }
        .progress-bar {
            height: 100%; width: 0%;
            background: repeating-linear-gradient(-45deg, #ef4444, #ef4444 10px, #f8fafc 10px, #f8fafc 20px);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .progress-label { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

        .inventory-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .item-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px; padding: 10px; display: flex; align-items: center; gap: 10px;
            cursor: pointer; transition: transform 0.1s; user-select: none;
        }
        .item-card:active { transform: scale(0.96); background: rgba(255,255,255,0.08); }
        .item-card.disabled { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
        .item-icon { font-size: 24px; }
        .item-details { display: flex; flex-direction: column; flex-grow: 1; }
        .item-name { font-size: 13px; font-weight: bold; }
        .item-gain { font-size: 11px; color: var(--accent-green); }
        .item-count { background: rgba(34, 197, 94, 0.15); color: #4ade80; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; }

        .scroll-hint { text-align: center; font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 5px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(3px); } }

        .leaderboard-section {
            background: #020617; 
            padding: 30px 20px 80px 20px;
            position: relative; z-index: 4; 
            border-top: 1px solid #1e293b;
        }
        .lb-title { text-align: center; color: var(--accent-gold); margin-bottom: 20px; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; }
        .lb-card { background: #0f172a; border-radius: 16px; padding: 15px; border: 1px solid #1e293b; }
        .lb-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
        .lb-row:last-child { border-bottom: none; }
        .lb-row.me { background: rgba(251, 191, 36, 0.1); border-radius: 8px; padding: 12px 10px; margin: 5px -10px; }
        .rank { width: 30px; color: #64748b; font-weight: bold; }
        .rank.top { color: #fbbf24; }
        .u-pts { color: var(--accent-green); font-family: monospace; font-weight: bold; font-size: 15px; }

        .toast { position: fixed; top: 10px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(34, 197, 94, 0.95); backdrop-filter: blur(5px); color: #fff; padding: 12px 24px; border-radius: 30px; font-weight: bold; font-size: 14px; z-index: 100; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: max-content; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.error { background: rgba(239, 68, 68, 0.95); }
    </style>
</head>
<body>

    <div id="debug-console"></div>

    <div class="background-layer"></div>
    <div class="snow-layer"></div>

    <div class="viewport">
        <div class="tree-stage" id="tree-stage">
            <svg class="tree-svg" viewBox="0 0 300 440" preserveAspectRatio="xMidYMax meet">
                <defs>
                    <linearGradient id="treeFill" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="#22c55e" />
                        <stop offset="40%" stop-color="#16a34a" />
                        <stop offset="100%" stop-color="#064e3b" />
                    </linearGradient>
                </defs>

                <rect x="120" y="380" width="60" height="50" fill="#5d4037" stroke="#281813" stroke-width="4" rx="2" />
                <ellipse cx="150" cy="380" rx="30" ry="10" fill="#8d6e63" stroke="#281813" stroke-width="4" />

                <path d="M150 40 Q180 120 230 160 Q250 180 210 180 Q260 260 280 300 Q290 320 240 320 Q280 380 290 395 L10 395 Q20 380 60 320 Q10 320 20 300 Q40 260 90 180 Q50 180 70 160 Q120 120 150 40 Z" fill="url(#treeFill)" />
                <path d="M130 80 Q150 90 180 75 M100 130 Q150 150 210 120 M70 200 Q150 230 240 190 M50 280 Q150 320 260 270 M30 360 Q150 410 270 350" fill="none" stroke="rgba(0,0,0,0.2)" stroke-width="2" stroke-linecap="round" />

                <g transform="translate(150, 40)">
                    <path class="star-shape" id="main-star" d="M0 -25 L7 -8 L25 -8 L10 5 L15 22 L0 12 L-15 22 L-10 5 L-25 -8 L-7 -8 Z" />
                </g>

                <circle cx="160" cy="85" r="4" class="svg-bulb c-red" />
                <circle cx="140" cy="82" r="4" class="svg-bulb c-yellow" />
                <circle cx="120" cy="135" r="4" class="svg-bulb c-blue" />
                <circle cx="160" cy="140" r="4" class="svg-bulb c-red" />
                <circle cx="190" cy="130" r="4" class="svg-bulb c-purple" />
                <circle cx="90" cy="210" r="4" class="svg-bulb c-yellow" />
                <circle cx="150" cy="215" r="4" class="svg-bulb c-blue" />
                <circle cx="210" cy="205" r="4" class="svg-bulb c-red" />
                <circle cx="70" cy="290" r="4" class="svg-bulb c-purple" />
                <circle cx="150" cy="300" r="4" class="svg-bulb c-red" />
                <circle cx="230" cy="285" r="4" class="svg-bulb c-yellow" />
                <circle cx="50" cy="375" r="4" class="svg-bulb c-blue" />
                <circle cx="150" cy="385" r="4" class="svg-bulb c-purple" />
                <circle cx="250" cy="370" r="4" class="svg-bulb c-red" />
            </svg>

            <div class="base-layer">
                <div class="gift blue"></div>
                <div class="gift"></div>
            </div>
        </div>

        <div class="control-panel">
            <div class="level-header">
                <span class="lvl-title">–£—Ä–æ–≤–µ–Ω—å –Å–ª–∫–∏</span>
                <span class="lvl-val" id="tree-lvl">...</span>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progress-fill"></div>
                <div class="progress-label" id="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div class="inventory-grid" id="inventory-grid"></div>
            <div class="scroll-hint">‚ñº –õ–∏—Å—Ç–∞–π –≤–Ω–∏–∑, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¢–æ–ø ‚ñº</div>
        </div>
    </div>

    <div class="leaderboard-section">
        <div class="lb-title">üèÜ –¢–æ–ø –í–∫–ª–∞–¥—á–∏–∫–æ–≤</div>
        <div class="lb-card">
            <div id="my-rank-container" style="margin-bottom:15px; border-bottom:1px dashed #334155; padding-bottom:10px;"></div>
            <div id="lb-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

<script>
    screenLog('Start initializing script...');

    // SUPABASE SETUP
    const SUPABASE_URL = "https://jnavsekwmitcajgvfafk.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYXZzZWt3bWl0Y2FqZ3ZmYWZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MDU1OTIsImV4cCI6MjA3NDE4MTU5Mn0.0NmAYM2hgzR7emeg45WpoSgqiHYizmtj8dGhMK7FOS4";
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: —É–±—Ä–∞–ª–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ let supabase; - –æ–Ω–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –≤–Ω—É—Ç—Ä–∏ DOMContentLoaded
    let supabaseClient;

    // GAME STATE
    let userId = null;
    let userName = "–ò–≥—Ä–æ–∫";
    let userInventory = {};
    let currentLevel = 1;
    let bulbs = [];

    const ITEMS = {
        '–®–∏—à–∫–∏': { pts: 10, emoji: 'üå≤' },
        '–°–Ω–µ–∂–∏–Ω–∫–∞': { pts: 20, emoji: '‚ùÑÔ∏è' },
        '–ì–∏—Ä–ª—è–Ω–¥–∞': { pts: 150, emoji: 'üéÑ' }, 
        '–Å–ª–æ—á–Ω–∞—è –∏–≥—Ä—É—à–∫–∞': { pts: 300, emoji: 'üîÆ' }
    };

    // --- MAIN EXECUTION ---
    document.addEventListener('DOMContentLoaded', async () => {
        if (window.logBuffer) {
            const consoleDiv = document.getElementById('debug-console');
            window.logBuffer.forEach(item => {
                const div = document.createElement('div');
                div.className = `log-${item.type}`;
                div.innerText = item.msg;
                consoleDiv.appendChild(div);
            });
        }
        
        screenLog('DOM –∑–∞–≥—Ä—É–∂–µ–Ω. –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ ID...');
        bulbs = document.querySelectorAll('.svg-bulb');

        try {
            const tg = window.Telegram.WebApp;
            const urlParams = new URLSearchParams(window.location.search);
            
            const idFromUrl = urlParams.get('user_id');
            const idFromTg = tg.initDataUnsafe && tg.initDataUnsafe.user ? String(tg.initDataUnsafe.user.id) : null;
            
            userId = idFromUrl || idFromTg;
            
            screenLog(`–õ–û–ì: ID –∏–∑ —Å—Å—ã–ª–∫–∏: ${idFromUrl}`);
            screenLog(`–õ–û–ì: ID –∏–∑ –¢–µ–ª–µ–≥—Ä–∞–º–∞: ${idFromTg}`);
            screenLog(`–õ–û–ì: –ò–¢–û–ì–û–í–´–ô ID: [${userId}]`);

            if (!userId) {
                screenLog('‚ùå –û–®–ò–ë–ö–ê: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å —Å—Å—ã–ª–∫—É –≤ –±–æ—Ç–µ.', 'error');
            } else {
                const nameFromUrl = urlParams.get('first_name');
                if (nameFromUrl) userName = decodeURIComponent(nameFromUrl);
                else if (tg.initDataUnsafe && tg.initDataUnsafe.user) userName = tg.initDataUnsafe.user.first_name;
                
                screenLog(`–ò–≥—Ä–æ–∫: ${userName} (ID: ${userId})`);
            }
        } catch (e) {
            screenLog('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ ID: ' + e.message, 'error');
        }

        try {
            if (typeof window.supabase === 'undefined') {
                throw new Error("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (–ø—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)");
            }
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç —Å –Ω–æ–≤—ã–º –∏–º–µ–Ω–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            screenLog('–ö–ª–∏–µ–Ω—Ç Supabase —Å–æ–∑–¥–∞–Ω.');

            if (userId) {
                screenLog('–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —ë–ª–∫–∏ –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å...');
                await Promise.all([
                    fetchTreeData(),
                    fetchInventory(),
                    fetchLeaderboard()
                ]);
                screenLog('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ.');
                setupRealtime();
            }
        } catch (e) {
            screenLog('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ' + e.message, 'error');
        }
    });

    // --- GAME FUNCTIONS ---

    async function fetchTreeData() {
        screenLog('Fetching Tree Data...');
        const { data, error } = await supabaseClient.from('users').select('level, xp').eq('id', 'global_tree').maybeSingle();
        if (error) {
            screenLog('Error fetching tree: ' + error.message, 'error');
            return;
        }
        if (data) {
            updateUI(data.level, data.xp);
        } else {
            screenLog('Global tree data not found in DB', 'warn');
        }
    }

    async function fetchInventory() {
        screenLog(`Fetching inventory for ${userId}...`);
        const { data, error } = await supabaseClient.from('inventory').select('item_name, quantity').eq('user_id', userId);
        if (error) {
            screenLog('Inventory Error: ' + error.message, 'error');
            return;
        }
        userInventory = {};
        if (data) data.forEach(i => userInventory[i.item_name] = i.quantity);
        renderInventory();
    }

    async function fetchLeaderboard() {
        const { data: top, error: errTop } = await supabaseClient.from('tree_contributors').select('*').order('points', {ascending:false}).limit(10);
        const { data: me, error: errMe } = await supabaseClient.from('tree_contributors').select('*').eq('user_id', userId).maybeSingle();
        
        if (errTop) screenLog('LB Error: ' + errTop.message, 'error');
        
        renderLeaderboard(top || [], me);
    }

    function updateUI(lvl, xp) {
        currentLevel = lvl;
        const max = lvl * 500;
        const pct = Math.min(100, Math.floor((xp/max)*100));
        
        const elLvl = document.getElementById('tree-lvl');
        const elFill = document.getElementById('progress-fill');
        const elText = document.getElementById('progress-text');

        if(elLvl) elLvl.textContent = lvl;
        if(elFill) elFill.style.width = pct + '%';
        if(elText) elText.textContent = `${xp} / ${max} (${pct}%)`;
        
        updateVisuals(pct);
    }

    function updateVisuals(percent) {
        const effectivePercent = Math.min(percent, 90); 
        const normalizedPercent = effectivePercent / 90; 
        const countToLight = Math.floor(normalizedPercent * bulbs.length);
        
        bulbs.forEach((bulb, i) => {
            if (i < countToLight) bulb.classList.add('on');
            else bulb.classList.remove('on');
        });

        const star = document.getElementById('main-star');
        if(star) {
            if (percent >= 90) {
                star.classList.add('star-glowing');
                const glowIntensity = (percent - 90) / 10; 
                const radius = 5 + (glowIntensity * 25);
                star.style.filter = `drop-shadow(0 0 ${radius}px #fbbf24)`;
            } else {
                star.classList.remove('star-glowing');
                star.style.filter = 'none';
            }
        }
    }

    function renderInventory() {
        const grid = document.getElementById('inventory-grid');
        if(!grid) return;
        grid.innerHTML = '';
        Object.entries(ITEMS).forEach(([name, info]) => {
            const qty = userInventory[name] || 0;
            const card = document.createElement('div');
            card.className = `item-card ${qty > 0 ? '' : 'disabled'}`;
            card.onclick = () => donate(name, info.pts);
            card.innerHTML = `
                <div class="item-icon">${info.emoji}</div>
                <div class="item-details">
                    <span class="item-name">${name}</span>
                    <span class="item-gain">+${info.pts} XP</span>
                </div>
                <div class="item-count">${qty}</div>
            `;
            grid.appendChild(card);
        });
    }

    function renderLeaderboard(list, me) {
        const cont = document.getElementById('lb-list');
        if(!cont) return;
        cont.innerHTML = '';
        if(!list.length) cont.innerHTML = '<div style="text-align:center; opacity:0.5;">–ü—É—Å—Ç–æ...</div>';
        list.forEach((u, i) => {
            const row = document.createElement('div');
            row.className = `lb-row ${String(u.user_id) === userId ? 'me' : ''}`;
            const rankIcon = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â': `#${i+1}`;
            row.innerHTML = `
                <span class="rank ${i<3?'top':''}">${rankIcon}</span>
                <span class="user-info" style="flex-grow:1; margin-left:10px;">${u.username}</span>
                <span class="u-pts">${u.points}</span>
            `;
            cont.appendChild(row);
        });
        const myCont = document.getElementById('my-rank-container');
        if(me && myCont) {
            myCont.innerHTML = `
                <div class="lb-row me">
                    <span class="rank top">‚òÖ</span>
                    <span class="user-info" style="flex-grow:1; margin-left:10px;">–í—ã (${me.username})</span>
                    <span class="u-pts">${me.points}</span>
                </div>`;
        }
    }

    async function donate(name, pts) {
        if ((userInventory[name] || 0) <= 0) return;
        
        userInventory[name]--; 
        renderInventory(); 
        
        screenLog(`Donating ${name} (${pts} pts)...`);

        try {
            const payload = {
                user_id_param: String(userId),
                user_name_param: String(userName),
                item_name_param: String(name),
                points_param: parseInt(pts)
            };

            const { data, error } = await supabaseClient.rpc('contribute_to_tree', payload);

            if (error) {
                throw error;
            }

            if (data && data.success === false) {
                throw new Error(data.message);
            }

            showToast(`‚úÖ –í–Ω–µ—Å–µ–Ω–æ: ${name}`);
            
            if (data && data.leveled_up) {
                screenLog("LEVEL UP!");
                showToast("üéâ –ù–û–í–´–ô –£–†–û–í–ï–ù–¨! –¢–æ–ø —Å–±—Ä–æ—à–µ–Ω!");
                setTimeout(fetchLeaderboard, 1000);
            }

        } catch (e) {
            screenLog(`Donate Failed: ${e.message}`, 'error');
            // Revert
            userInventory[name]++; 
            renderInventory();
            showToast('‚ùå –û—à–∏–±–∫–∞: ' + e.message, true);
        }
    }

    function showToast(text, err=false) {
        const t = document.getElementById('toast');
        if(t) {
            t.innerText = text; 
            t.className = `toast show ${err?'error':''}`;
            setTimeout(() => t.classList.remove('show'), 2000);
        }
    }

    function setupRealtime() {
        screenLog('Subscribing to Realtime...');
        supabase.channel('global_tree_rt')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'users', filter: 'id=eq.global_tree' }, 
            (payload) => { 
                if (payload.new.level !== currentLevel) fetchLeaderboard();
                updateUI(payload.new.level, payload.new.xp);
            })
            .subscribe();
        
        supabase.channel('my_inventory_rt')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'inventory', filter: `user_id=eq.${userId}` }, 
            () => fetchInventory() 
            )
            .subscribe();
        
        supabase.channel('lb_rt')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'tree_contributors' }, 
            () => setTimeout(fetchLeaderboard, 1500)
        ).subscribe();
    }
</script>
</body>
</html>